<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Walkthrough E2E Tests | My Muqabala</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #1a1a2e; color: #eee; padding: 24px; }
        h1 { font-size: 1.3rem; color: #B8AECC; margin-bottom: 4px; }
        .subtitle { color: #6B5A9C; font-size: 0.8rem; margin-bottom: 20px; }
        .controls { margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap; }
        .controls button {
            padding: 8px 16px; border: 1px solid #6B5A9C; border-radius: 8px;
            background: rgba(107, 90, 156, 0.1); color: #B8AECC; cursor: pointer;
            font-size: 0.8rem; transition: background 0.2s;
        }
        .controls button:hover { background: rgba(107, 90, 156, 0.25); }
        .controls button.active { background: #6B5A9C; color: #fff; }
        .summary { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; display: none; }
        .summary-card { padding: 12px 20px; border-radius: 10px; text-align: center; min-width: 90px; }
        .summary-card .count { font-size: 1.6rem; font-weight: 700; }
        .summary-card .label { font-size: 0.7rem; opacity: 0.7; }
        .card-pass { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
        .card-fail { background: rgba(244, 67, 54, 0.15); color: #f44336; }
        .card-miss { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
        .card-total { background: rgba(107, 90, 156, 0.15); color: #B8AECC; }
        #log { font-family: monospace; font-size: 0.8rem; line-height: 1.6; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; padding: 16px; background: #16213e; border-radius: 8px; }
        .log-pass { color: #4caf50; }
        .log-fail { color: #f44336; }
        .log-warn { color: #ffc107; }
        .log-info { color: #7ec8e3; }
        #spinner { display: none; color: #B8AECC; margin-bottom: 12px; }
    </style>
</head>
<body>
    <h1>Form Walkthrough E2E Tests</h1>
    <p class="subtitle">Validates form loading, schema, structure, and integration for all 33 forms</p>

    <div class="controls">
        <button onclick="runGroup(null)" class="active">All Groups</button>
        <button onclick="runGroup('express')">Express (4)</button>
        <button onclick="runGroup('scenarios')">Scenarios (10)</button>
        <button onclick="runGroup('germination')">Germination (6)</button>
        <button onclick="runGroup('racines')">Racines (5)</button>
        <button onclick="runGroup('patterns')">Patterns (4)</button>
        <button onclick="runGroup('valeurs')">Valeurs (3)</button>
        <button onclick="runGroup('bilan')">Bilan (1)</button>
    </div>

    <div id="spinner">Running tests...</div>
    <div class="summary" id="summary"></div>
    <div id="log"></div>

    <script>window.FORM_REGISTRY = {};</script>
    <script src="../../chat-schema-validator.js"></script>
    <script src="form-walkthrough.test.js"></script>
    <script>
        const logEl = document.getElementById('log');
        const summaryEl = document.getElementById('summary');
        const spinnerEl = document.getElementById('spinner');

        // Override console.log to display in page
        const _origLog = console.log;
        console.log = function(...args) {
            _origLog.apply(console, args);
            const line = args.join(' ');
            const span = document.createElement('span');

            if (line.includes('\u2705')) span.className = 'log-pass';
            else if (line.includes('\u274C')) span.className = 'log-fail';
            else if (line.includes('warning') || line.includes('missing') || line.includes('Missing')) span.className = 'log-warn';
            else if (line.includes('===') || line.includes('RESULTS')) span.className = 'log-info';

            span.textContent = line + '\n';
            logEl.appendChild(span);
            logEl.scrollTop = logEl.scrollHeight;
        };

        async function runGroup(groupName) {
            logEl.innerHTML = '';
            summaryEl.style.display = 'none';
            spinnerEl.style.display = 'block';

            // Update active button
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            await new Promise(r => setTimeout(r, 50));

            const results = await FormWalkthroughTests.run(groupName);

            spinnerEl.style.display = 'none';

            // Show summary cards
            const passed = results.filter(r => r.passed).length;
            const failed = results.filter(r => !r.passed && !r.details.includes('not found')).length;
            const missing = results.filter(r => r.details.includes('not found')).length;

            summaryEl.style.display = 'flex';
            summaryEl.innerHTML =
                '<div class="summary-card card-total"><div class="count">' + results.length + '</div><div class="label">Total</div></div>' +
                '<div class="summary-card card-pass"><div class="count">' + passed + '</div><div class="label">Passed</div></div>' +
                '<div class="summary-card card-fail"><div class="count">' + failed + '</div><div class="label">Failed</div></div>' +
                '<div class="summary-card card-miss"><div class="count">' + missing + '</div><div class="label">Missing</div></div>';
        }
    </script>
</body>
</html>
